#!/usr/bin/env bash

title='Unclean - WARNING'
backtitle='Checking Unix Home...'

_missing()
{
    if [[ ! -e "${1}" ]]
    then
        msg="${1} not found.\nCopy it from ${2} in the repository."
        dialog --title "Missing - WARNING" --backtitle "Checking Unix Home..." --msgbox "${msg}" 12 44
    fi
}

_dirmissing()
{
    if [[ ! -e "${1}" ]]
    then
        msg="${1} not found.\nSee README.md in the repository."
        dialog --title "Missing - ERROR" --backtitle "Checking Unix Home..." --msgbox "${msg}" 12 44
    fi

    if [[ ! -f "${1}/.unix-home" ]]
    then
        msg="${1} is not the one provided by the package. See README.md in the repository."
        dialog --title "Missing - ERROR" --backtitle "Checking Unix Home..." --msgbox "${msg}" 12 44
    fi
}

_misplaced()
{
    if [[ -e "${1}" ]]
    then
        msg="${1} exists.\nFile should reside in ${2}!\nPlease check ${3} setting in ${4},\nand perhaps delete the misplaced file."
        dialog --title "Misplaced - WARNING" --backtitle "Checking Unix Home..." --msgbox "${msg}" 12 44
    fi
}

_unnecessary()
{
    if [[ -e "${1}" ]]
    then
        msg="${1} exists.\nFile cannot be placed elsewhere, but you might want to check if you can do without it."
        dialog --title "Unnecessary - WARNING" --backtitle "Checking Unix Home..." --msgbox "${msg}" 12 44
    fi
}

_dirmissing "${HOME}/.config"
_dirmissing "${HOME}/.local"
_dirmissing "${HOME}/.local/state"
_dirmissing "${HOME}/.local/share"

_missing "/etc/profile.d/clean_home.sh" "system/etc/profile.d"

# History files
_misplaced "${HOME}/.less_history" "${XDG_STATE_HOME:-${HOME}/.local/state}" "LESSHISTFILE" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh/profile"
_misplaced "${HOME}/.bash_history" "${XDG_STATE_HOME:-${HOME}/.local/state}" "HISTFILE" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh/bash_profile"
_misplaced "${HOME}/.gdb_history" "${XDG_STATE_HOME:-${HOME}/.local/state}" "'set history filename'" "${XDG_CONFIG_HOME:-${HOME}/.config}/gdb/gdbinit"

_misplaced "${HOME}/.profile" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh" "sourcing" "/etc/profile.d/clean_home.sh"
_misplaced "${HOME}/.bash_profile" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh" "sourcing" "/etc/profile.d/clean_home.sh"

_misplaced "${HOME}/.npmrc" "${XDG_CONFIG_HOME:-${HOME}/.config}/npm" "NPM_CONFIG_USERCONFIG" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh/profile"

_misplaced "${HOME}/.dircolors" "${XDG_CONFIG_HOME:-${HOME}/.config}/dircolors" "sourcing" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh/bash_profile"

_misplaced "${HOME}/.viminfo" "${XDG_STATE_HOME:-${HOME}/.local/state}" "viminfofile" "${XDG_CONFIG_HOME:-${HOME}/.config}/vim/vimrc"
_misplaced "${HOME}/.vimrc" "${XDG_CONFIG_HOME:-${HOME}/.config}/vim" "VIMINIT" "${XDG_CONFIG_HOME:-${HOME}/.config}/sh/profile"
_misplaced "${HOME}/.vim" "${XDG_CONFIG_HOME:-${HOME}/.config}/vim" "runtimepath / packpath" "${XDG_CONFIG_HOME:-${HOME}/.config}/vim/vimrc"

_unnecessary "${HOME}/.bash_logout"
_unnecessary "${HOME}/.bashrc"

if [[ -r /etc/profile.d/update-motd.sh ]]
then
    if ! grep -q "\$HOME/\.local" /etc/profile.d/update-motd.sh
    then
        dialog --title "HINT" --backtitle "Checking Unix Home..." --msgbox "/etc/profile.d/update-motd.sh contains references to .dotfiles.\nReplace '\$HOME/.' with '\$HOME/.local/state/' in the file to fix that." 12 44
    fi
fi
