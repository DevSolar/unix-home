#!/bin/bash

shopt -s nocasematch

P4EXE="/usr/bin/p4"

if [[ ! -x "${P4EXE}" ]]
then
    echo "Perforce is not installed."
    exit 1
fi

while IFS= read -r line
do
    if [[ $line =~ ^Client\ (.*)\ [0-9]{4}/[0-9]{2}/[0-9]{2}\ root\ (.*)\ \'.*\'$ ]]
    then
        client=${BASH_REMATCH[1]}
        path=$(realpath $(wslpath ${BASH_REMATCH[2]}))
        if [[ $PWD/ == $path/* ]]
        then
            export P4CLIENT=$client
        fi
    fi
done <<< $($P4EXE clients -u $P4USER)

"${P4EXE}" "$@"
