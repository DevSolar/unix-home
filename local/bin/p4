#!/bin/bash

shopt -s nocasematch

POSSIBLE_P4=("/usr/bin/p4" "/c/Program Files/Perforce/p4.exe")

P4EXE=""

for path in "${POSSIBLE_P4[@]}"
do
    if [[ -x "$path" ]]
    then
        P4EXE="$path"
        break
    fi
done

if [[ -z "$P4EXE" ]]
then
    echo "P4 not installed."
    exit 1
fi

currentdir="$(realpath $PWD)/"

if which wslpath > /dev/null 2>&1
then
    pathconv="wslpath"
elif which cygpath > /dev/null 2>&1
then
    pathconv="cygpath"
else
    echo "Neither wslpath nor cygpath installed."
    exit 1
fi

while IFS= read -r line
do
    if [[ $line =~ ^Client\ (.*)\ [0-9]{4}/[0-9]{2}/[0-9]{2}\ root\ (.*)\ \'.*\'.*$ ]]
    then
        client=${BASH_REMATCH[1]}
        path=$($pathconv ${BASH_REMATCH[2]})
        if [[ $currentdir == $path/* ]]
        then
            export P4CLIENT=$client
        fi
    fi
done <<< $("$P4EXE" clients -u $P4USER)

"${P4EXE}" "$@"
